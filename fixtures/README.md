# Test Fixtures

Baseline CSV fixtures for regression testing. Use these to verify that refactors do not silently change parsing behavior.

## Files

### `01_clean_small.csv` — Happy path
- **5 rows**, all valid CAD deals, no edge cases
- Has "generated by" date line before header
- **Expected:** 5 deals parsed, 0 filtered, 0 deduplicated

### `02_multiline_notes.csv` — Multiline quoted fields
- **4 rows** with note fields containing newlines, escaped quotes (`""`), bullet lists, and email addresses inside quoted CSV fields
- Tests the character-by-character CSV parser (not just line-split)
- **Expected:** 4 deals parsed, all notes preserved with original line breaks intact

### `03_malformed_rows.csv` — Row validation & currency filtering
- **10 rows total**, only **4 should survive**:

| Row | Deal Name | Why Filtered / Kept |
|-----|-----------|---------------------|
| 1 | Acme Corp Renewal | **Kept** — valid CAD deal |
| 2 | Beta Industries | Filtered — `$75000 USD` |
| 3 | Gamma EU Deal | Filtered — `€95000 EUR` |
| 4 | Delta Financial | Filtered — owner has 6 words |
| 5 | Epsilon Retail | Filtered — empty owner |
| 6 | (empty name) | Filtered — empty deal name |
| 7 | Zeta Logistics | **Kept** — invalid date becomes null (999 days since) |
| 8 | Eta Manufacturing | **Kept** — `$0 CAD` is valid |
| 9 | Theta Corp | Filtered — `US$` prefix = USD |
| 10 | Iota Services | **Kept** — HTML tags stripped from note |

- **Expected:** 4 deals kept, 6 filtered. Iota note becomes plain text: `Proposal sent on Feb 7.IncludesTraining2yr term` (or similar after HTML strip)

### `04_duplicate_deals.csv` — Deduplication logic
- **9 rows**, exercises dedup key = `dealName.toLowerCase().trim()`

| Deal Name | Rows | Expected Winner |
|-----------|------|-----------------|
| Acme Corp Renewal | 3 (+ 1 whitespace-padded) | `2026-02-12` row (if trim matches, 4 dupes → newest wins) |
| Beta Industries | 1 | Kept as-is |
| Delta Financial / delta financial | 2 (case difference) | `2026-02-09` row (case-insensitive match) |
| Epsilon Retail | 2 (one with no date) | `2026-02-10` row (date beats no-date) |

- **Expected:** 4 unique deals after dedup. All notes from duplicates collected for AI summary.

### `05_large_mixed.csv` — Combined stress test
- **47 rows** combining all edge cases:
  - 40 valid CAD deals (various owners, stages, dates)
  - 2 non-CAD rows (1 USD, 1 EUR) → filtered
  - 1 malformed owner (6 words) → filtered
  - 1 empty deal name → filtered
  - 3 rows for "Duplicate Deal Alpha" → deduplicated to 1
  - Multiline quoted notes on several deals
  - Mix of recent and stale dates for urgency spread
- **Expected:** ~40 unique deals after filtering and dedup

## Test Harness

Open `test-harness.html` in a browser (via local server) to automatically run all fixtures through the app.js pipeline and compare against golden snapshots.

```bash
python -m http.server 8000
# Open http://localhost:8000/test-harness.html
```

The harness will show PASS/FAIL for each fixture. If a golden file is missing, it shows "NO GOLDEN".

### Golden files (`expected/`)

Each `expected/<fixture>.json` contains a sorted array of deal snapshots with these fields:

| Field | Description |
|-------|-------------|
| `deal_key` | `dealName.toLowerCase().trim()` — the dedup key |
| `deal_owner` | Raw deal owner string |
| `stage` | Deal stage |
| `acv` | Parsed numeric ACV (CAD only) |
| `closing_date` | ISO date string or null |
| `modified_date` | ISO date string or null |
| `notes_hash` | djb2 hash of stripped note content |
| `notes_summary_length` | Character length of fallback summary |

### Regenerating golden files

After an **intentional** behavior change, regenerate:

```bash
node fixtures/generate-golden.js
```

Or click "Download Golden Files" in the test harness page to download all 5 JSON files.
